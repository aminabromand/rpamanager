{% extends "base.html" %}

{% block content %}

<style type="text/css">
	.numberbox {
    	width: 5em;
	}
</style>


	<div class='container'>
		<div class='row'>
			<div class='col-12 col-md-6'>
					<h1> Service Tasks </h1>
				<div class='row'>
					<div class='col-12'>
						{% if object %}
							{% include 'processes/navbar.html' with objects=service_tasks active_id=object.id %}
						{% else %}
							{% include 'processes/navbar.html' with objects=service_tasks %}
						{% endif %}

					</div>
				</div>

				<div class='row'>
					<div class='col-12'>

						{% if object %}
							{% url 'processes:update_service_task-save' object.id as service_task_action %}
							{% url 'processes:delete_service_task' object.id as delete_service_task %}
							{% url 'processes:service_task_list' as service_task_list %}
							<h1> {{ object.name }} </h1>
							<form class="service-task-form" method='POST' action="{{ service_task_action }}" delete="{{ delete_service_task }}" data-next-url="{{ service_task_list }}">
						{% else %}
							{% url 'processes:create_service_task-save' as service_task_action %}
							<h1> New Service Task </h1>
							<form class="service-task-form" method='POST' action="{{ service_task_action }}">
						{% endif %}
						
								{% csrf_token %}
								<table>
									{{ form }}
								</table>
								<div class='mx-3 my-3'>
									<button type='submit' class='btn btn-default'>Save</button>
									<button type='reset' class='btn btn-default'>Reset</button>
									<button type='reset' name='delete' class='btn btn-default'>Delete</button>
								</div>
						</form>
					</div>
				</div>
			</div>

			<div class='col-12 col-md-6'>
				<h1>Calculate Efforts</h1>

				<div class='row'>
					<div class='col-12'>
						{% if calc_schema_object %}
							{% include 'calcschemas/navbar.html' with objects=calc_schemas active_id=calc_schema_object.id %}
						{% else %}
							{% include 'calcschemas/navbar.html' with objects=calc_schemas %}
						{% endif %}
					</div>
				</div>
				
				<div class='row'>
					<div class='col-12'>

						{% if calc_schema_object %}
							<h1> {{ calc_schema_object.name }} </h1>
							{% include 'calcschemas/form.html' with form=calc_schema_form object=calc_schema_object form_class='calc-schema-form' %}
						{% else %}
							<h1> New Calc Schema </h1>
							{% include 'calcschemas/form.html' with form=calc_schema_form object=None form_class='calc-schema-form' %}
						{% endif %}

					</div>
				</div>
			</div>
		</div>
	</div>


	        	

{% endblock %}

{% block javascript %}

<script type="text/javascript">
	$(document).ready(function() {
    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
});
</script>

<script type="text/javascript">
	
	$(document).ready(function() {

		function prepareForm(documentForm) {

			var documentFormMethod = documentForm.attr("method");
			var documentFormEndpoint = documentForm.attr("action");

			var deleteBtn = documentForm.find("[name='delete']");
			var documentFormDeleteEndpoint = documentForm.attr("delete");
			var nextUrl = documentForm.attr('data-next-url');
			

			documentForm.submit(function(event) {
				event.preventDefault();

				var documentFormData = documentForm.serialize();

				$.ajax({
					method: documentFormMethod,
					url: documentFormEndpoint,
					data: documentFormData,
					success: function(data) {

						//setTimeout(function() {
						//	displaySubmitting(documentFormSubmitBtn, documentFormSubmitBtnTxt, false)}, 500);

						//documentForm[0].reset();
						$.alert({
							title: "Success!",
							// content: data.form_saved,
							content: data.msg,
							theme: "modern"});
					},
					error: function(errorData) {
						console.log(errorData.responseJSON);

						//setTimeout(function() {
						//	displaySubmitting(documentFormSubmitBtn, documentFormSubmitBtnTxt, false)}, 500);

						var jsonData = errorData.responseJSON;
						var msg = "";

						$.each(jsonData, function(key, value) { // key, value VS array index, object
							msg += key + ": " + value[0].message + "<br/>";
						});

						$.alert({
							title: "Oops!",
							content: "msg",
							theme: "modern"});
					}
				});
			});


			function redirectToNext(nextPath, timeoffset) {
				if (nextPath) {
					setTimeout(function(){
						window.location.href = nextPath;
					}, timeoffset);
				}
			}


			deleteBtn.click(function(event) {
				var documentFormData = documentForm.serialize();

				$.ajax({
					method: "DELETE",
					url: documentFormDeleteEndpoint,
					data: documentFormData,
					success: function(data) {

						//setTimeout(function() {
						//	displaySubmitting(documentFormSubmitBtn, documentFormSubmitBtnTxt, false)}, 500);

						//documentForm[0].reset();
						$.alert({
							title: "Success!",
							// content: data.form_saved,
							content: data.msg,
							theme: "modern"});
						redirectToNext(nextUrl, 1500);
					},
					error: function(errorData) {
						console.log(errorData.responseJSON);

						//setTimeout(function() {
						//	displaySubmitting(documentFormSubmitBtn, documentFormSubmitBtnTxt, false)}, 500);

						var jsonData = errorData.responseJSON;
						var msg = "";

						$.each(jsonData, function(key, value) { // key, value VS array index, object
							msg += key + ": " + value[0].message + "<br/>";
						});

						$.alert({
							title: "Oops!",
							content: "msg",
							theme: "modern"});
					}
				});
			});
		}

		var serviceTaskForm = $(".service-task-form");
		prepareForm(serviceTaskForm);
		var calcSchemaForm = $(".calc-schema-form");
		prepareForm(calcSchemaForm);
		


	});

</script>

<script type="text/javascript">

	$(document).ready(function() {

		var calculationForm = $(".service-task-calculation-form");
		var refreshBtn = calculationForm.find("[name='refresh']");

		var size_field = $("#id_calc_size");
		var effort_field = $("#id_calc_effort");
		var effort_field_d = $("#id_calc_effort_d");

		var size_m = parseInt($("#id_calc_size_m").val());
		var size_l = parseInt($("#id_calc_size_l").val());
		


		function calculateSize() {

			var size = 0;

			size = size + parseInt($("#id_panel_count").val());
			size = size + parseInt($("#id_input_field_count").val());
			size = size + parseInt($("#id_button_count").val());
			size = size + parseInt($("#id_dropdown_count").val());
			size = size + parseInt($("#id_checkbox_count").val());
			size = size + parseInt($("#id_radio_button_count").val());
			size = size + parseInt($("#id_file_input_count").val());

			var size_selection = 'X';

			if (size >= size_l) {
				size_selection = 'L';
			} else if (size >= size_m) {
				size_selection = 'M';
			} else {
				size_selection = 'S';
			}

			return size_selection;

		}

		function calculateEfforts(size) {

			var effort = 0;

			effort = effort + parseInt($("#id_panel_base").val()) * parseInt($("#id_panel_count").val());
			effort = effort + parseInt($("#id_input_field_base").val()) * parseInt($("#id_input_field_count").val());
			effort = effort + parseInt($("#id_button_base").val()) * parseInt($("#id_button_count").val())
			effort = effort + parseInt($("#id_dropdown_base").val()) * parseInt($("#id_dropdown_count").val());
			effort = effort + parseInt($("#id_checkbox_base").val()) * parseInt($("#id_checkbox_count").val());
			effort = effort + parseInt($("#id_radio_button_base").val()) * parseInt($("#id_radio_button_count").val());
			effort = effort + parseInt($("#id_file_input_base").val()) * parseInt($("#id_file_input_count").val());


			if (size == 'L') {
				size_factor = parseFloat($("#id_factor_l").val());;
			} else if (size == 'M') {
				size_factor = parseFloat($("#id_factor_m").val());;
			} else {
				size_factor = parseFloat($("#id_factor_s").val());;
			}

			effort = effort * size_factor;

			return effort;
		}

		function refreshCalculation() {

			
			var size = calculateSize();
			size_field.val(size);

			
			var effort = calculateEfforts(size);
			effort_field.val(effort);
			effort_field_d.val(effort / 8);

		}
	
		$(".service-task-form").find("input").change(refreshCalculation);

		
		refreshBtn.click(function(event) {
			event.preventDefault();
			refreshCalculation();
		});

		refreshCalculation();
	});

</script>


{% endblock %}


